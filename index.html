// Updated JavaScript for your chatbot with real NOAA weather integration
// Replace the existing JavaScript in your index.html with this

const chatArea = document.getElementById('chatArea');
const messageInput = document.getElementById('messageInput');
const typingIndicator = document.getElementById('typingIndicator');

// Static responses for non-weather data (for now)
const staticResponses = {
    'ferry': {
        'text': 'Seattle - Bainbridge Island Ferry Status:',
        'data': {
            'Next Departure (Seattle)': '2:35 PM - M/V Wenatchee',
            'Following Departure': '3:25 PM - M/V Spokane',
            'Current Crossing Time': '35 minutes',
            'Service Status': 'On schedule ‚úÖ',
            'Vehicle Deck': '70% capacity',
            'Passenger Deck': 'Moderate crowds',
            'Estimated Wait': 'Walk-ons: None, Vehicles: 15 min'
        }
    },
    'port': {
        'text': 'Port of Seattle Terminal Operations:',
        'data': {
            'Terminal 18': 'Active - MSC Margherita loading',
            'Terminal 46': 'Active - 2 vessels at berth',
            'Terminal 5': 'Maintenance - Reopens 6:00 PM',
            'Grain Terminal (86)': 'Loading M/V Pacific Dawn',
            'Traffic Congestion': 'Light to moderate',
            'Pilot Services': 'Normal operations',
            'Harbor Status': 'Open - no restrictions'
        }
    },
    'traffic': {
        'text': 'Current vessel traffic in Elliott Bay area:',
        'data': {
            'Commercial Vessels': '14 ships in vicinity',
            'Inbound Traffic': '3 container ships, 1 tanker',
            'Outbound Traffic': '2 bulk carriers departing',
            'At Anchor': '6 vessels awaiting berth',
            'Ferry Operations': 'Normal service all routes',
            'Recreational Traffic': 'Moderate weekend activity',
            'Traffic Restrictions': 'None currently active'
        }
    },
    'tide': {
        'text': 'Seattle tide information - ' + new Date().toLocaleDateString(),
        'data': {
            'Current Level': '4.1 feet and rising',
            'High Tide Today': '4:45 PM (11.6 feet)',
            'Low Tide Tonight': '10:42 PM (1.8 feet)',
            'Next High Tide': 'Tomorrow 5:23 AM (10.4 feet)',
            'Tidal Current': 'Flood tide - 1.4 knots',
            'Extreme Tides': 'Spring tide period',
            'Current Set': 'Northbound in main channel'
        }
    },
    'warning': {
        'text': 'Active maritime notices for Puget Sound region:',
        'data': {
            'Navigation': 'Construction near Pier 70 - reduced speed',
            'Dredging': 'Duwamish Waterway - daylight hours',
            'Marine Event': 'Sailing regatta Lake Union 1-5 PM',
            'Bridge Status': 'Ballard Bridge - normal operations',
            'VHF Radio Check': 'Seattle Traffic - Channel 14',
            'Coast Guard': 'Sector Puget Sound - normal ops',
            'Last Updated': '30 minutes ago'
        }
    }
};

// Fetch real weather data from NOAA
async function fetchRealWeather() {
    try {
        const response = await fetch('/api/weather');
        
        if (!response.ok) {
            throw new Error('Weather service unavailable');
        }
        
        const weatherData = await response.json();
        
        return {
            text: `Real-time marine conditions for ${weatherData.location}:`,
            data: {
                'Wind': weatherData.conditions.wind,
                'Temperature': weatherData.conditions.temperature,
                'Visibility': weatherData.conditions.visibility,
                'Humidity': weatherData.conditions.humidity,
                'Barometric Pressure': weatherData.conditions.pressure,
                'Sea State': weatherData.maritime.seaState,
                'Conditions': weatherData.maritime.conditions,
                'Small Craft Advisory': weatherData.maritime.smallCraftAdvisory ? 'Active ‚ö†Ô∏è' : 'None',
                'Last Updated': new Date(weatherData.timestamp).toLocaleTimeString()
            }
        };
        
    } catch (error) {
        console.error('Weather fetch error:', error);
        
        // Fallback to static data if API fails
        return {
            text: 'Marine conditions for Puget Sound (cached data):',
            data: {
                'Status': 'Live weather temporarily unavailable',
                'Wind': 'NW 12-15 knots (estimated)',
                'Visibility': '10+ nautical miles',
                'Sea State': 'Moderate (2-3 ft waves)',
                'Conditions': 'Use caution - verify conditions',
                'Note': 'Check VHF weather radio for updates',
                'Fallback': 'Real-time data will resume shortly'
            }
        };
    }
}

function addMessage(content, isUser = false, hasData = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
    
    let messageContent = `<div class="message-content">${content}`;
    
    if (hasData && typeof content === 'object') {
        messageContent = `<div class="message-content">${content.text}`;
        for (const [key, value] of Object.entries(content.data)) {
            messageContent += `<div class="data-card"><h5>${key}</h5>${value}</div>`;
        }
    }
    
    messageContent += '</div>';
    messageDiv.innerHTML = messageContent;
    chatArea.appendChild(messageDiv);
    
    setTimeout(() => {
        chatArea.scrollTop = chatArea.scrollHeight;
    }, 100);
}

function showTyping() {
    typingIndicator.style.display = 'block';
    chatArea.scrollTop = chatArea.scrollHeight;
}

function hideTyping() {
    typingIndicator.style.display = 'none';
}

async function getResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    // Check if requesting weather data
    if (lowerMessage.includes('weather') || lowerMessage.includes('conditions') || lowerMessage.includes('wind')) {
        return await fetchRealWeather();
    }
    
    // Use static responses for other data types
    if (lowerMessage.includes('ferry') || lowerMessage.includes('bainbridge') || lowerMessage.includes('schedule')) {
        return staticResponses.ferry;
    } else if (lowerMessage.includes('port') || lowerMessage.includes('terminal') || lowerMessage.includes('seattle') || lowerMessage.includes('tacoma')) {
        return staticResponses.port;
    } else if (lowerMessage.includes('traffic') || lowerMessage.includes('vessel') || lowerMessage.includes('ship')) {
        return staticResponses.traffic;
    } else if (lowerMessage.includes('tide') || lowerMessage.includes('current') || lowerMessage.includes('water level')) {
        return staticResponses.tide;
    } else if (lowerMessage.includes('warning') || lowerMessage.includes('navigation') || lowerMessage.includes('notice')) {
        return staticResponses.warning;
    } else {
        return {
            text: "I provide real-time maritime information for the Pacific Northwest. I can help with:",
            data: {
                'üå§Ô∏è Marine Weather': 'Live NOAA conditions, wind, visibility, forecasts',
                '‚õ¥Ô∏è Ferry Services': 'WSF schedules, delays, capacity information',
                'üè≠ Port Operations': 'Terminal status, vessel schedules, congestion',
                'üö¢ Vessel Traffic': 'Ship movements, anchorages, channel status',
                'üåä Tides & Currents': 'Tide tables, current predictions, water levels',
                '‚ö†Ô∏è Marine Notices': 'Navigation warnings, restrictions, safety alerts'
            }
        };
    }
}

async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    addMessage(message, true);
    messageInput.value = '';

    showTyping();
    
    try {
        const response = await getResponse(message);
        
        setTimeout(() => {
            hideTyping();
            addMessage(response, false, true);
        }, 1000);
        
    } catch (error) {
        setTimeout(() => {
            hideTyping();
            addMessage("Sorry, I'm having trouble accessing maritime data right now. Please try again in a moment.", false);
        }, 1000);
    }
}

async function sendQuickMessage(message) {
    addMessage(message, true);
    
    showTyping();
    
    try {
        const response = await getResponse(message);
        
        setTimeout(() => {
            hideTyping();
            addMessage(response, false, true);
        }, 800);
        
    } catch (error) {
        setTimeout(() => {
            hideTyping();
            addMessage("Maritime data temporarily unavailable. Please try again.", false);
        }, 800);
    }
}

// Event listeners
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});

window.addEventListener('load', function() {
    messageInput.focus();
});

// Welcome sequence with real weather
setTimeout(async () => {
    addMessage("üí° I now provide real-time NOAA weather data! Try asking about current marine conditions.", false);
}, 3000);

// Prevent zoom on double tap (mobile)
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, false);
